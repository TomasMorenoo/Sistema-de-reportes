{% extends "base.html" %}

{% block title %}Estadísticas - Sistema de Reportes{% endblock %}

{% block extra_styles %}
.stat-card {
    transition: transform 0.2s, box-shadow 0.2s;
}
.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
.stat-number {
    font-size: 2.5rem;
    font-weight: bold;
}
.stat-icon {
    font-size: 3rem;
    opacity: 0.2;
    position: absolute;
    right: 20px;
    top: 20px;
}
.promedio-card {
    border-left: 4px solid;
}
.promedio-mes {
    border-left-color: #0d6efd;
}
.promedio-semana {
    border-left-color: #6c757d;
}
.temporal-card {
    border-left: 4px solid;
}
.temporal-dia {
    border-left-color: #ffc107;
}
.temporal-mes {
    border-left-color: #9b59b6;
}
#dia-display, #mes-display {
    min-height: 200px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}
.btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
}
.display-4 {
    font-weight: bold;
}
.btn-outline-warning:hover:not(:disabled) {
    background-color: #ffc107;
    color: #000;
}
.btn-outline-secondary:hover:not(:disabled) {
    background-color: #9b59b6;
    color: #fff;
    border-color: #9b59b6;
}
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="fas fa-chart-bar text-primary"></i> Estadísticas de Reportes
    </h1>
</div>

<!-- Total de Reportes - Card Principal -->
<div class="card stat-card shadow mb-4 border-0 bg-primary text-white">
    <div class="card-body position-relative">
        <i class="fas fa-clipboard-list stat-icon"></i>
        <h5 class="card-title mb-3">
            <i class="fas fa-database"></i> Total de Reportes Registrados
        </h5>
        <p class="stat-number mb-0">{{ total }}</p>
        <small class="text-white-50">En {{ meses_activos }} mes{% if meses_activos != 1 %}es{% endif %} de actividad</small>
    </div>
</div>

<!-- Ganador del Mes y Top 3 Ganadores en la misma línea -->
<div class="row g-4 mb-4">
  <!-- Ganador del Mes -->
  <div class="col-md-6">
    <div class="card shadow h-100 border-0">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="card-title mb-0">
            <i class="fas fa-trophy text-warning"></i> Empleado del Mes
          </h5>
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-gdm-prev">
              <i class="fas fa-chevron-left"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-gdm-next">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>

        <div id="gdm-display" class="text-center">
          <span class="badge bg-light text-dark border mb-2" id="gdm-etiqueta">—</span>
          <div class="mt-3">
            <div class="mt-2" id="gdm-winners">[]</div>
          </div>
          <small class="text-muted d-block mt-2" id="gdm-posicion"></small>
        </div>

        <!-- Datos JSON embebidos -->
        <script id="meses-gdm" type="application/json">
          {{ meses_ganadores_navegable|safe }}
        </script>
      </div>
    </div>
  </div>

  <!-- Top 3 Ganadores -->
  <div class="col-md-6">
    <div class="card shadow h-100 border-0">
      <div class="card-body">
        <h5 class="card-title mb-3">
          <i class="fas fa-crown text-primary"></i> Top 3 Ganadores
          <small class="text-muted d-block">Quienes más veces ganaron “Empleado del mes”</small>
        </h5>

        {% if top3_ganadores_mes and top3_ganadores_mes|length > 0 %}
        <ol class="list-group list-group-numbered list-group-flush">
          {% for persona, veces in top3_ganadores_mes %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>{{ persona }}</span>
            <span class="badge bg-secondary">{{ veces }}</span>
          </li>
          {% endfor %}
        </ol>
        {% else %}
        <div class="alert alert-info mb-0">
          <i class="fas fa-info-circle"></i> Aún no hay ganadores mensuales registrados.
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>




<!-- NUEVAS SECCIONES: Estadísticas Temporales con Navegación -->
<div class="row g-4 mb-4">
    <!-- Reportes por Día -->
    <div class="col-md-6">
        <div class="card temporal-card temporal-dia shadow h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-calendar-day text-warning"></i> Reportes por Día
                    </h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-warning" id="btn-dia-prev">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-warning" id="btn-dia-next">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                
                {% if por_dia and por_dia|length > 0 %}
                    <div class="text-center" id="dia-display">
                        <div class="mb-3">
                            <h4 class="text-warning mb-1" id="dia-fecha"></h4>
                            <small class="text-muted" id="dia-posicion"></small>
                        </div>
                        <div class="mb-3">
                            <div class="display-4 text-dark" id="dia-cantidad"></div>
                            <small class="text-muted">reportes</small>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-warning" id="dia-progress" style="width: 0%"></div>
                        </div>
                    </div>
                    <script id="datos-dias" type="application/json">
                    {{ por_dia|safe }}
                    </script>
                {% else %}
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle"></i> No hay datos de reportes por día
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Reportes por Mes -->
    <div class="col-md-6">
        <div class="card temporal-card temporal-mes shadow h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-calendar-alt" style="color: #9b59b6;"></i> Reportes por Mes
                    </h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-mes-prev" style="border-color: #9b59b6; color: #9b59b6;">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-mes-next" style="border-color: #9b59b6; color: #9b59b6;">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                
                {% if por_mes and por_mes|length > 0 %}
                    <div class="text-center" id="mes-display">
                        <div class="mb-3">
                            <h4 class="mb-1" style="color: #9b59b6;" id="mes-nombre"></h4>
                            <small class="text-muted" id="mes-posicion"></small>
                        </div>
                        <div class="mb-3">
                            <div class="display-4 text-dark" id="mes-cantidad"></div>
                            <small class="text-muted">reportes</small>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar" id="mes-progress" style="width: 0%; background-color: #9b59b6;"></div>
                        </div>
                    </div>
                    <script id="datos-meses" type="application/json">
                    {{ por_mes|safe }}
                    </script>
                {% else %}
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle"></i> No hay datos de reportes por mes
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Grid de Estadísticas -->
<div class="row g-4">
    <div class="col-md-6">
        <div class="card stat-card shadow h-100 border-0">
            <div class="card-body">
                <h5 class="card-title mb-3">
                    <i class="fas fa-tasks text-info"></i> Reportes por Estado
                </h5>
                {% if por_estado %}
                <ul class="list-group list-group-flush">
                    {% for estado, cantidad in por_estado %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>
                            {% if estado == 'resuelto' %}
                                <i class="fas fa-check-circle text-success"></i> Resuelto
                            {% elif estado == 'en proceso' %}
                                <i class="fas fa-hourglass-half text-warning"></i> En Proceso
                            {% else %}
                                <i class="fas fa-clock text-danger"></i> Pendiente
                            {% endif %}
                        </span>
                        <span class="badge bg-primary rounded-pill fs-6">{{ cantidad }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">No hay datos disponibles</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card stat-card shadow h-100 border-0">
            <div class="card-body">
                <h5 class="card-title mb-3">
                    <i class="fas fa-building text-success"></i> Top 5 Oficinas con más reportes
                </h5>
                {% if por_oficina %}
                <ul class="list-group list-group-flush">
                    {% for oficina, cantidad in por_oficina %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>
                            <i class="fas fa-door-open"></i> {{ oficina.capitalize() }}
                        </span>
                        <span class="badge bg-info rounded-pill fs-6">{{ cantidad }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">No hay datos disponibles</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card stat-card shadow h-100 border-0">
            <div class="card-body">
                <h5 class="card-title mb-3">
                    <i class="fas fa-layer-group text-warning"></i> Reportes por Piso
                </h5>
                {% if por_piso %}
                <ul class="list-group list-group-flush" style="max-height: 350px; overflow-y: auto;">
                    {% for piso, cantidad in por_piso %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>
                            <i class="fas fa-arrows-alt-v"></i> Piso {{ piso }}
                        </span>
                        <span class="badge bg-success rounded-pill fs-6">{{ cantidad }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">No hay datos disponibles</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card stat-card shadow h-100 border-0">
            <div class="card-body">
                <h5 class="card-title mb-3">
                    <i class="fas fa-user-check text-danger"></i> Top 5 - Quienes resolvieron más reportes
                </h5>
                {% if top_resueltos %}
                <ul class="list-group list-group-flush">
                    {% for persona, cantidad in top_resueltos %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>
                            <i class="fas fa-user"></i> {{ persona }}
                        </span>
                        <span class="badge bg-warning text-dark rounded-pill fs-6">{{ cantidad }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle"></i> Aún no hay reportes resueltos registrados
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="text-center mt-5 mb-4">
    <a href="{{ url_for('index') }}" class="btn btn-secondary btn-lg me-2">
        <i class="fas fa-home"></i> Ir al Inicio
    </a>
    <a href="{{ url_for('generar_excel') }}" class="btn btn-success btn-lg">
        <i class="fas fa-file-excel"></i> Descargar Excel
    </a>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const datosDiasElement = document.getElementById('datos-dias');
    if (datosDiasElement) {
        try {
            const diasArray = JSON.parse(datosDiasElement.textContent);
            console.log('Datos días:', diasArray);
            
            if (!Array.isArray(diasArray) || diasArray.length === 0) return;
            
            let diaActual = 0;
            const maxDia = Math.max(...diasArray.map(item => item[1]));
            
            function mostrarDia(index) {
                if (index < 0) index = 0;
                if (index >= diasArray.length) index = diasArray.length - 1;
                diaActual = index;
                
                const [fecha, cantidad] = diasArray[index];
                document.getElementById('dia-fecha').textContent = fecha;
                document.getElementById('dia-cantidad').textContent = cantidad;
                document.getElementById('dia-posicion').textContent = `Día ${index + 1} de ${diasArray.length}`;
                document.getElementById('dia-progress').style.width = (cantidad / maxDia * 100).toFixed(1) + '%';
                document.getElementById('btn-dia-prev').disabled = (index === 0);
                document.getElementById('btn-dia-next').disabled = (index === diasArray.length - 1);
            }
            
            document.getElementById('btn-dia-prev').addEventListener('click', () => mostrarDia(diaActual - 1));
            document.getElementById('btn-dia-next').addEventListener('click', () => mostrarDia(diaActual + 1));
            mostrarDia(diasArray.length - 1);
        } catch (e) {
            console.error('Error días:', e);
        }
    }
    
    const datosMesesElement = document.getElementById('datos-meses');
    if (datosMesesElement) {
        try {
            const mesesArray = JSON.parse(datosMesesElement.textContent);
            console.log('Datos meses:', mesesArray);
            
            if (!Array.isArray(mesesArray) || mesesArray.length === 0) return;
            
            let mesActual = 0;
            const maxMes = Math.max(...mesesArray.map(item => item[1]));
            
            function mostrarMes(index) {
                if (index < 0) index = 0;
                if (index >= mesesArray.length) index = mesesArray.length - 1;
                mesActual = index;
                
                const [mes, cantidad] = mesesArray[index];
                document.getElementById('mes-nombre').textContent = mes;
                document.getElementById('mes-cantidad').textContent = cantidad;
                document.getElementById('mes-posicion').textContent = `Mes ${index + 1} de ${mesesArray.length}`;
                document.getElementById('mes-progress').style.width = (cantidad / maxMes * 100).toFixed(1) + '%';
                document.getElementById('btn-mes-prev').disabled = (index === 0);
                document.getElementById('btn-mes-next').disabled = (index === mesesArray.length - 1);
            }
            
            document.getElementById('btn-mes-prev').addEventListener('click', () => mostrarMes(mesActual - 1));
            document.getElementById('btn-mes-next').addEventListener('click', () => mostrarMes(mesActual + 1));
            mostrarMes(mesesArray.length - 1);
        } catch (e) {
            console.error('Error meses:', e);
        }
    }

// --- Navegación "Ganador del Mes" ---
const gdmEl = document.getElementById('meses-gdm');
if (gdmEl) {
  try {
    const mesesGDM = JSON.parse(gdmEl.textContent); // [{clave, etiqueta, winners:[[nombre, count], ...]}]
    if (Array.isArray(mesesGDM) && mesesGDM.length > 0) {
      let idx = mesesGDM.length - 1; // mostrar último mes por defecto
      const etiquetaEl = document.getElementById('gdm-etiqueta');
      const posEl = document.getElementById('gdm-posicion');
      const winnersEl = document.getElementById('gdm-winners');

      function renderGDM(i) {
        if (i < 0) i = 0;
        if (i >= mesesGDM.length) i = mesesGDM.length - 1;
        idx = i;

        const item = mesesGDM[i];
        etiquetaEl.textContent = item.etiqueta || '—';
        posEl.textContent = `Mes ${i + 1} de ${mesesGDM.length}`;

        if (Array.isArray(item.winners) && item.winners.length > 0) {
          winnersEl.innerHTML = item.winners
            .map(([nombre, n]) => `<span class="badge bg-warning text-dark me-2">${nombre} (${n})</span>`)
            .join(' ');
        } else {
          winnersEl.textContent = '[]';
        }

        document.getElementById('btn-gdm-prev').disabled = (idx === 0);
        document.getElementById('btn-gdm-next').disabled = (idx === mesesGDM.length - 1);
      }

      document.getElementById('btn-gdm-prev').addEventListener('click', () => renderGDM(idx - 1));
      document.getElementById('btn-gdm-next').addEventListener('click', () => renderGDM(idx + 1));
      renderGDM(idx);
    }
  } catch (e) {
    console.error('Error Ganador del Mes:', e);
  }
}

});
</script>
{% endblock %}