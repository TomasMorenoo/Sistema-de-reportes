{% extends "base.html" %}

{% block title %}Nuevo Reporte - Sistema de Reportes{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock %}

{% block extra_styles %}
.persona-row {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 10px;
}
.persona-row select {
    flex: 1;
}
.btn-remove-persona {
    width: 40px;
    height: 38px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}
#personas-container .persona-row:first-child .btn-remove-persona {
    visibility: hidden;
}
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow-lg">
            <div class="card-header bg-primary text-white text-center">
                <h3 class="mb-0">üìù Cargar Nuevo Reporte</h3>
            </div>
            <div class="card-body">
                <form method="POST" id="formReporte">

                    <!-- Piso -->
                    <div class="mb-3">
                        <label for="piso" class="form-label">Piso</label>
                        <select name="piso" id="piso" class="form-select" required>
                            <option value="" disabled selected>Seleccionar piso</option>
                            {% for i in range(-3, 5) %}
                                <option value="{{ i }}">{{ i }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Oficina -->
                    <div class="mb-3">
                        <label for="oficina" class="form-label">Oficina</label>
                        <select class="form-select" id="oficina" name="oficina" required>
                            <option value="" disabled selected>Selecciona primero un piso</option>
                        </select>
                    </div>

                    <!-- Quien reporta -->
                    <div class="mb-3">
                        <label for="quien" class="form-label">Qui√©n reporta</label>
                        <input type="text" name="quien" id="quien" class="form-control" placeholder="Ej: Juan P√©rez" required>
                    </div>

                    <!-- Raz√≥n del reporte -->
                    <div class="mb-3">
                        <label for="razon" class="form-label">Raz√≥n del reporte</label>
                        <textarea name="razon" id="razon" class="form-control" rows="3" placeholder="Describe el problema..." required></textarea>
                    </div>

                    <!-- Fecha del reporte -->
                    <div class="mb-3">
                        <label class="form-label">Fecha del reporte</label>
                        <div class="btn-group w-100 mb-2" role="group" id="fecha-opciones">
                            <input type="radio" class="btn-check" name="fecha_opcion" id="fecha_hoy" value="hoy" checked>
                            <label class="btn btn-outline-primary" for="fecha_hoy">HOY</label>
                            
                            <input type="radio" class="btn-check" name="fecha_opcion" id="fecha_ayer" value="ayer">
                            <label class="btn btn-outline-primary" for="fecha_ayer">AYER</label>
                            
                            <input type="radio" class="btn-check" name="fecha_opcion" id="fecha_otra" value="otra">
                            <label class="btn btn-outline-primary" for="fecha_otra">OTRA FECHA</label>
                        </div>
                        <div id="calendario-container" style="display: none;">
                            <input type="date" class="form-control" id="fecha_custom" name="fecha_custom">
                        </div>
                    </div>

                    <!-- Campo oculto para la fecha final -->
                    <input type="hidden" name="fecha_reporte" id="fecha_reporte_hidden">

                    <!-- Estado -->
                    <div class="mb-3">
                        <label for="estado" class="form-label">Estado</label>
                        <select name="estado" id="estado" class="form-select" required>
                            <option value="" disabled selected>Seleccionar estado</option>
                            <option value="pendiente">Pendiente</option>
                            <option value="en proceso">En proceso</option>
                            <option value="resuelto">Resuelto</option>
                        </select>
                    </div>

                    <!-- Resuelto por - Din√°mico -->
                    <div class="mb-3" id="resuelto-section" style="display: none;">
                        <label class="form-label">Resuelto por</label>
                        <div id="personas-container">
                            <div class="persona-row">
                                <select class="form-select persona-select" data-placeholder="Seleccionar persona">
                                    <option value=""></option>
                                    <option value="Tomas">Tomas</option>
                                    <option value="Norela">Norela</option>
                                    <option value="Nahuel">Nahuel</option>
                                    <option value="Adrian">Adrian</option>
                                    <option value="Marcelo">Marcelo</option>
                                    <option value="Chloe">Chloe</option>
                                </select>
                                <button type="button" class="btn btn-danger btn-remove-persona">
                                    <i class="fas fa-minus"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-success btn-sm mt-2" id="btn-add-persona">
                            <i class="fas fa-plus"></i> Agregar otra persona
                        </button>
                    </div>

                    <!-- Campo oculto para enviar las personas -->
                    <input type="hidden" name="resuelto_por" id="resuelto_por_hidden">

                    <div class="d-flex justify-content-between mt-4">
                        <a href="{{ url_for('index') }}" class="btn btn-secondary">‚Üê Cancelar</a>
                        <button type="submit" class="btn btn-success">‚úÖ Guardar Reporte</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js_libs %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
{% endblock %}

{% block extra_js %}
<script>
    const oficinasPorPiso = {{ oficinas_json | safe }};

    function actualizarOficinas(piso) {
        const oficinas = oficinasPorPiso[piso] || [];
        const $oficina = $('#oficina');
        $oficina.empty();
        
        if(oficinas.length === 0) {
            $oficina.append('<option value="" disabled>No hay oficinas para este piso</option>');
        } else {
            $oficina.append('<option value="" disabled selected>Seleccion√° una oficina</option>');
            oficinas.forEach(ofi => {
                $oficina.append(new Option(ofi, ofi));
            });
        }
        $oficina.trigger('change');
    }

    function inicializarSelect2Persona($select) {
        $select.select2({
            placeholder: "Seleccionar persona",
            allowClear: true,
            width: '100%'
        });
    }

    function agregarPersona() {
        const nuevaFila = `
            <div class="persona-row">
                <select class="form-select persona-select" data-placeholder="Seleccionar persona">
                    <option value=""></option>
                    <option value="Tomas">Tomas</option>
                    <option value="Chloe">Chloe</option>
                    <option value="Nahuel">Nahuel</option>
                    <option value="Marcelo">Marcelo</option>
                    <option value="Adrian">Adrian</option>
                    <option value="Norela">Norela</option>
                </select>
                <button type="button" class="btn btn-danger btn-remove-persona">
                    <i class="fas fa-minus"></i>
                </button>
            </div>
        `;
        
        $('#personas-container').append(nuevaFila);
        const $nuevoSelect = $('#personas-container .persona-row:last-child .persona-select');
        inicializarSelect2Persona($nuevoSelect);
    }

    function eliminarPersona(btn) {
        const $container = $('#personas-container');
        if ($container.find('.persona-row').length > 1) {
            $(btn).closest('.persona-row').remove();
        }
    }

    function recopilarPersonas() {
        const personas = [];
        $('.persona-select').each(function() {
            const valor = $(this).val();
            if (valor && valor.trim() !== '') {
                personas.push(valor);
            }
        });
        return personas.join(', ');
    }

    $(document).ready(function() {
        $('#piso').select2({
            placeholder: "Seleccion√° un piso",
            allowClear: true
        });
        
        $('#oficina').select2({
            placeholder: "Seleccion√° una oficina",
            allowClear: true
        });

        inicializarSelect2Persona($('.persona-select').first());

        $('#piso').on('change', function() {
            actualizarOficinas($(this).val());
        });

        $('#estado').on('change', function() {
            if ($(this).val() === 'resuelto') {
                $('#resuelto-section').slideDown();
            } else {
                $('#resuelto-section').slideUp();
            }
        });

        $('#btn-add-persona').on('click', function() {
            agregarPersona();
        });

        $(document).on('click', '.btn-remove-persona', function() {
            eliminarPersona(this);
        });

        // Manejo de la fecha del reporte
        $('input[name="fecha_opcion"]').on('change', function() {
            if ($(this).val() === 'otra') {
                $('#calendario-container').slideDown();
            } else {
                $('#calendario-container').slideUp();
            }
        });

        // Establecer fecha m√°xima en el calendario (no puede ser mayor a hoy)
        const hoy = new Date();
        const fechaMax = hoy.toISOString().split('T')[0];
        $('#fecha_custom').attr('max', fechaMax);

        $('#formReporte').on('submit', function(e) {
            // PRIMERO: Calcular y establecer la fecha del reporte
            const fechaOpcion = $('input[name="fecha_opcion"]:checked').val();
            let fechaFinal;
            
            // Obtener fecha actual
            const ahora = new Date();
            
            if (fechaOpcion === 'hoy') {
                const dia = String(ahora.getDate()).padStart(2, '0');
                const mes = String(ahora.getMonth() + 1).padStart(2, '0');
                const anio = String(ahora.getFullYear()).slice(-2);
                fechaFinal = `${dia}/${mes}/${anio}`;
            } else if (fechaOpcion === 'ayer') {
                const ayer = new Date(ahora);
                ayer.setDate(ayer.getDate() - 1);
                const dia = String(ayer.getDate()).padStart(2, '0');
                const mes = String(ayer.getMonth() + 1).padStart(2, '0');
                const anio = String(ayer.getFullYear()).slice(-2);
                fechaFinal = `${dia}/${mes}/${anio}`;
            } else if (fechaOpcion === 'otra') {
                const fechaCustom = $('#fecha_custom').val();
                if (!fechaCustom) {
                    e.preventDefault();
                    alert('Por favor selecciona una fecha del calendario');
                    return false;
                }
                // Parsear la fecha en formato YYYY-MM-DD
                const [anioCompleto, mesStr, diaStr] = fechaCustom.split('-');
                const anio = anioCompleto.slice(-2);
                fechaFinal = `${diaStr}/${mesStr}/${anio}`;
            }
            
            // Establecer el valor de la fecha
            $('#fecha_reporte_hidden').val(fechaFinal);

            // SEGUNDO: Validar personas si es resuelto
            const estado = $('#estado').val();
            if (estado === 'resuelto') {
                const personasSeleccionadas = recopilarPersonas();
                if (personasSeleccionadas === '') {
                    e.preventDefault();
                    alert('Debes seleccionar al menos una persona que resolvi√≥ el reporte');
                    return false;
                }
                $('#resuelto_por_hidden').val(personasSeleccionadas);
            } else {
                $('#resuelto_por_hidden').val('');
            }
            
            // El formulario se enviar√° normalmente despu√©s de esto
        });
    });
</script>
{% endblock %}